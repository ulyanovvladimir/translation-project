<!--- Copyright (C) 2009-2015 Typesafe Inc. <http://www.typesafe.com> -->
# Интеграция с Akka

[Akka](http://akka.io/) использует Акторную модель чтобы повысить уровень абстракции и предоставить лучшую платформу для построения корректных параллельных и масштабируемых приложений. Для отказоустойчивости используется модель ‘Позволь ему упасть’, которая было использована с огромным успехом в индустрии телекоммуникации для построения самовосстанавливающихся приложений - систем, которые никогда не останавливаются. Акторы также предоставляют абстракцию для прозрачного распределения нагрузки и базис для реально масштабируемых и отказоустойчивых приложений.

## Акторная система приложения

Akka может работать с различными контейнерами, так называемыми акторными системами. Акторная система управляет ресурсами, которые ей были отданы на стадии конфигурации для запуска акторов, которые она содержит. 

Приложения Play определяют специальную акторную систему чтобы использовать ее в приложении. Эта акторная система сопровождает жизненный цикл приложения и перезапускается автоматически, когда перезапускается приложение.

### Написание акторов

Чтобы начать использовать Akka, вам потребуется написать актор. Ниже приведен пример простого актора, который просто говорит hello любому, кто бы его не спросил.

@[actor](code/javaguide/akka/HelloActor.java)

Обратите внимание, что `HelloActor` определяет статический метод с именем `props`, который возвращает объект `Props`, который описывает как создавать актор. Это хорошие конвенции Akka для разделения логики создания экземпляра от кода, который создает объект актора.  

Еще один отличный прием - то, что сообщения, которые  `HelloActor` отправляет и получает определяется статическими внутренними классами другого класса с именем `HelloActorProtocol`:

@[protocol](code/javaguide/akka/HelloActorProtocol.java)

### Создание и использование акторов

Чтобы создать и/или использовать актор, вам потребуется `ActorSystem`. Ее можно получить, объявив зависимость от ActorSystem когда вы используете `actorOf` метод для создания нового актора.    

Самое базовое действие, которое вы можете сделать с актором - это отправить ему сообщение. Когда вы отправляете сообщение актору, нет никакого ответа, оно отрабатывает по принципу "пустил-забыл". Это также известно как _tell_ паттерн. 

В веб приложении, однако, паттерн _tell_ часто не используется, т.к. HTTP это протокол, который имеет запросы и ответы. В этом случае, более вероятно, что вы захотите использовать паттерн _ask_. Паттерн _ask_ возвращает Scala-вский `Future`, который вы можете конвертировать в объект Java `CompletionStage` с помощью `scala.compat.java8.FutureConverts.toJava`, и затем отобразить в ваш собственный тип результата.

Ниже приведен пример использования нашего `HelloActor` с паттерном ask:

@[ask](code/javaguide/akka/ask/Application.java)

Отметим несколько моментов:

* Паттерн ask должен быть проимпортирован, часто самым удобным способом является статический импорт метода `ask`.
* Возвращаемый объект в будущем конвертируется в `CompletionStage`.  Результирующий promise - `CompletionStage<Object>`, поэтому когда вы обращаетесь к его значению вам необходимо произвести приведение к типу результата, которого вы ожидаете от актора.
* Паттерн ask требует задержки, которую мы определили в 1000 миллисекунд. Если актор работает дольше, чем это время, возвращаемый promise будет завершен с ошибкой по таймауту.
* С тех пор как мы создаем актор в конструкторе, нам необходимо поместить наш контроллер в `Singleton`, так чтобы этот новый актор не создавался каждый раз, когда используется этот контроллер.

## Внедрение зависимостей для акторов

Если вам так предпочтительнее, вы можете использовать Guice для создания ваших акторов и привязки акторов к вашем контроллерам и компонентам.

Например, если вы хотите иметь актор, который завиит от конфигурации Play, вы вожможно делаете это:

@[injected](code/javaguide/akka/ConfiguredActor.java)

Play предоставляет несколько хелперов для того чтобы помочь привязать актор. Они позволяет самому актору быть способным внедриться, и позволяет ActorRef для актора быть внедренным в другой компонент. Чтобы привязать актор с помощью этих хелперов создайте модуль, как описано в [[документации по dependency injection|JavaDependencyInjection#Play-applications]], затм примешайте [`AkkaGuiceSupport`](api/java/play/libs/akka/AkkaGuiceSupport.html) интерфейс и используйте метод `bindActor` для привязки актора: 

@[binding](code/javaguide/akka/modules/MyModule.java)

Актор получит имя `configured-actor`, и будет доступен по имени `configured-actor` для внедрения. Теперь вы можете завязаться на актор в вашем контроллере и других компонентах:

@[inject](code/javaguide/akka/inject/Application.java)

### Внедрение зависимостей от дочерних акторов

Сказанное выше хорошо для внедрения корневых акторов, но много акторов, которые вы создадите будут дочерними акторами, которые не ограничены жизненным циклом приложения Play, и могут иметь дополнительное состояние, переданное им.

Для того чтобы помочь во внедрении зависимостей от дочерних акторов, Play предоставляет вспомогательную утилиту Guice-а [AssistedInject](https://github.com/google/guice/wiki/AssistedInject).

Скажем, у вас есть следующий актор, который зависит от конфигурации и ключа

@[injectedchild](code/javaguide/akka/ConfiguredChildActor.java)

В этом случае мы использовали внедрение конструктора - Guice AssistedInject совместим только с внедрением конструктора. т.к. параметр `key` будет предоставлен при создании, не контейнером, мы дали ему аннотацию `@Assisted`.

Теперь в протоколе для дочернего актора мы определяем интерфейс `Factory`, который принимает `key` и возвращает `Actor`:   

@[protocol](code/javaguide/akka/ConfiguredChildActorProtocol.java)

Мы не будем это реализовывать, Guice это сделает за нас, предоставив реализацию, которая не только передаст параметр `key`, но еще и предоставит `Configuration`-зависимость и внедрит ее. Так как трэйт лишь возвращает `Actor`, в момент тестирования этого актора мы можем внедрить фактор, который возвращает любой актор, например, это позволяет нам внедрить заглушку-дочерний-актор вместо настоящего. 

Теперь актор, который зависит от него может расширить [`InjectedActorSupport`](api/java/play/libs/akka/InjectedActorSupport.html) и он может зависеть от factory, который мы создали:

@[injectedparent](code/javaguide/akka/ParentActor.java)

Здесь используется `injectedChild` для создания и получения ссылки на дочерних актор, передавая ему key.

Наконц, нам нужно привязать наши акторы. В нашем модуле мы используем метод `bindActorFactory` для привязки родительского актора, а также привязывает дочерний фэктори для реализации дочернего элемента:

@[factorybinding](code/javaguide/akka/factorymodules/MyModule.java)

Это заставит Guice автоматичски связать экземпляр `ConfiguredChildActorProtocol.Factory`, который передаст экземпляр `Configuration` в `ConfiguredChildActor` при его создании.

## Конфигурация

Конфигурация акторной системы по умолчанию считывается из конфигурационного файла приложения Play. Например, для того чтобы сконфигурировать диспетчер акторной системы приложения, добавьте следующие строки в  файл `conf/application.conf`:

@[conf](code/javaguide/akka/akka.conf)

Для конфигурации журнализации Akka, см. [[конфигурацию журнализации|SettingsLogger]].

### Изменение префикса конфиуграции

В том случае, если вы хотите использовать настройки `akka.*` для другой системы акторов, вы можете сказать Play загрузить его Akka настройки из другого места.  

```
play.akka.config = "my-akka"
```

Теперь настройки будут считываться из префикса `my-akka` вместо `akka`.

```
my-akka.actor.default-dispatcher.fork-join-executor.pool-size-max = 64
my-akka.actor.debug.receive = on
```

### Имя встроенной акторной системы

По умолчанию именем акторной системы Play является  `application`. Вы можете изменить через запись в `conf/application.conf`:

```
play.akka.actor-system = "custom-name"
```

> **Замечание:** Эта особенность полезна, если вы хотите поместить ActorSystem вашего приложения play  в akka-класстер .

## Асинхронный запуск блока кода

Стандартный пример использования Akka - выполнить некоторые вычисления параллельно без необходимости создания дополнительной утилиты в виде Актора. если вы находите, что создание пула акторов по причине выполнения вычислений в параллели, есть более простой (и более быстрый) способ:     

@[async](code/javaguide/akka/async/Application.java)

## Планировщик асинхронных задач

Вы можете запланировать отправку сообщений акторам и выполнение задач (функций или экземпляров `Runnable`). Обратно вы получаете объект `Cancellable` у которого можете вызвать метод `cancel` для отмены выполнения запланированной операции.    

Например, чтобы отправить сообщение `testActor` каждые 30 минут:

@[schedule-actor](code/javaguide/akka/JavaAkka.java)

Альтернативно, чтобы запустить блок кода через 10 миллисекунд от текущего момента:

@[schedule-code](code/javaguide/akka/JavaAkka.java)
