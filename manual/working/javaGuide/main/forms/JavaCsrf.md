<!--- Copyright (C) 2009-2015 Typesafe Inc. <http://www.typesafe.com> -->
# Защита от Cross Site Request Forgery

Cross Site Request Forgery (CSRF) это способ проникновения, когда атакующий принуждает браузер жертвы сделать запрос, использующий сессию жертвы. Так как токен сессии отправляется в каждом запросе, если атакующий сможет принудить браузер жертвы выполнить запрос от своего лица, атакующий может выполнить запрос от лица пользователя. 

Рекомендуется узнать поближе, что такое CSRF, какие векторы атаки, и что ими не является. Мы рекомендуем начать с [этой информации от OWASP](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29)

Проще говоря, атакующий может вынудить браузер жертвы выполнить следующие типы запросов:

* Все `GET` запросы
* `POST` запросы с телом типа `application/x-www-form-urlencoded`, `multipart/form-data` и `text/plain`

Атакующий не может:

* Вынудить браузер использовать другие методы запроса, такие как `PUT` and `DELETE`
* Вынудить браузер отправить POST других типов контента, таких как `application/json`
* Вынудить браузер отправить новые куки, отличные от тех, которые сервер уже выставил.
* Вынудить браузер установить произвольные заголовки, отличные от нормальных заголовков, которые браузер добавляет к запросам. 

Так как предполагается, что `GET` запросы не приводят к изменениям, нет опасности для приложений, которые используют эту практику. Поэтому единственные запросы, которые нуждаются в CSRF защите - это `POST` запросы с указанными выше типами контента.

### Защита от  CSRF в Play  

Play поддерживает множество методов для верификации того, что запрос не является CSRF запросом. Главный механизм - это CSRF токен. Этот токен размещается либо в строке запроса или в теле каждой отправляемой формы, и также размещается в пользовательской сессии. Play затем верифицирует оба этих токена и проверяет их соответствие.

Чтобы предоставить простую защиту от не браузерных запросов, таких как запросы, выполняемые через AJAX, Play также предоставляет следующее:

* Если присутствует заголовок `X-Requested-With`, Play рассматривает запрос как безопасный.  `X-Requested-With` добавляется в запрос многими популярными Javascript библиотеками, такими как jQuery.
* Если присутствует заголовок `Csrf-Token` со значением `nocheck`, или с валидным CSRF токеном, Play будет рассматривать этот запрос как безопасный.

## Применение глобального CSRF фильтра

Play предоставляет глобальный CSRF фильтр, который не может быть применен ко всем запросам. Это простейший способ добавить CSRF защиту в приложение. Чтобы включить глобальный фильтр, добавте зависимость от фильтров-хелперов Play в ваш проект в файле `build.sbt`:  

```scala
libraryDependencies += filters
```

Теперь добавьте их в ваш класс `Filters` :

@[filters](code/javaguide/forms/csrf/Filters.java)

Класс `Filters` может быть либо в корне пакета, либо, если он имеет другое имя или находится в другом пакете, должен быть сконфигурирован с помощью `play.http.filters` в `application.conf`:

```
play.http.filters = "filters.MyFilters"
```

### Получение текущего токена

Текущий CSRF токен может быть доступен с помощью метода `CSRF.getToken`.  Он принимает `RequestHeader`, который может быть получен с помощью `Controllers.request()`:

@[get-token](code/javaguide/forms/JavaCsrf.java)

Чтобы помочь в добавлении CSRF токенов в форму, Play предоставляет некоторые хелперы шаблона. Первый добавляет его в строку запроса URL контроллера формы: 

@[csrf-call](code/javaguide/forms/csrf.scala.html)

В результате получится форма, которая выглядит следующим образом:

```html
<form method="POST" action="/items?csrfToken=1234567890abcdef">
   ...
</form>
```

Нежелательно, чтобы токен присутствовал в строке запроса, поэтому Play также предоставляет хелпер для добавления CSRF токен в качестве скрытого поля формы:

@[csrf-input](code/javaguide/forms/csrf.scala.html)

Отрендеренная форма будет выглядить примерно так:

```html
<form method="POST" action="/items">
   <input type="hidden" name="csrfToken" value="1234567890abcdef"/>
   ...
</form>
```

### Добавление CSRF токена в сессию

Чтобы убедиться, что CSRF токен доступен для рендеринга в формах, и отправлен назад клиенту,  глобальный фильтр сгенерирует новый токен для всех GET запросов, который принимает HTML, если токен уже не доступен во входящем запросе.

## Применение CSRF фильтрации на основе отдельных контроллеров

Иногда глобальная CSRF фильтрация может не подойти, например в ситуациях, где приложение захочет позволит некоторую перекрестную форму отправки. Некоторые стандарты ,базирующиеся не на сессии, такие как OpenID 2.0, требует использовать кросс-сайтовую форму отправки, или использовать отправку формы в сервер-сервер RPC коммуникациях.

В этих случаях Play предоставляет два действия-контроллера, которые могут быть скомпонованы с контроллерами ваших приложений.

Первый контроллер - это `play.filters.csrf.RequireCSRFCheck` который предоставляет проверку CSRF. Он должен быть добавлен во все методы, которые предоставляют отправку форму методом POST в аутентифицированной сессии:

@[csrf-check](code/javaguide/forms/JavaCsrf.java)

Второй контроллер - это `play.filters.csrf.AddCSRFToken`, он генерирует токен CSRF , если он еще не присутствует во входящем запросе. Он должен быть добавлен во все контроллеры, которые рендерят формы:

@[csrf-add-token](code/javaguide/forms/JavaCsrf.java)

## Опции конфигурации CSRF

Полный спектр опций конфигурации CSRF может быть найден в описании фильтров [reference.conf](resources/confs/filters-helpers/reference.conf).  Некоторые примеры включают:

* `play.filters.csrf.token.name` - Имя токена чтобы использовать и в сессии и в теле/строке запроса. По-умолчанию равняется `csrfToken`.
* `play.filters.csrf.cookie.name` - Если сконфигурировано, Play будет хранить CSRF токен в cookie с данным именем вместо сессии.
* `play.filters.csrf.cookie.secure` - Если `play.filters.csrf.cookie.name` установлен, указывает должен ли CSRF cookie иметь установленный флаг секурности. По-умолчанию имеет то же значение, что и `play.http.session.secure`.
* `play.filters.csrf.body.bufferSize` - Для того чтобы читать токены вне тела, Play должен сперва буфферизировать тело и потенциально пропарсить его. Эта опция устанавливает максимальный размер буффера для буфферизации тела запроса.  По-умолчанию равен 100k.
* `play.filters.csrf.token.sign` - Должен ли Play использовать подписанные CSRF токены. Подписанные CSRF токены убеждают, что значение токена сгенерировано случайным образом для каждого запроса, таким оборазом, защищая от BREACH стиля атак.
